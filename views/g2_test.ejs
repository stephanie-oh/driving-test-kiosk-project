<!DOCTYPE html>
<html lang="en">
  <%- include('layouts/header'); -%>
  <body>
    <div class="header">
        <h1>G2 Test</h1>
    </div>
    <%- include('layouts/dashnav'); -%>
    <div class="main">
      <h2>G2 Test</h2>
      <p>Enter your details below to register</p>
      <div class="form_con">
        <form id="g2Form" action="/update_details" method="post">
          <fieldset>
            <legend>Personal Information</legend>
            <label for="fname">First Name</label>
            <input type="text" id="fname" name="firstname"><br><br>
            <label for="lname">Last Name</label>
            <input type="text" id="lname" name="lastname"><br><br>
            <label for="age">Age</label>
            <input type="number" id="age" name="Age"><br><br>
            <label for="dob">Date of Birth</label>
            <input type="date" id="dob" name="dob"><br><br>
            <label for="lnum">License Number</label>
            <input type="text" id="lnum" name="LicenseNo">
          </fieldset>
          <fieldset>
            <legend>Car Information</legend>
            <label for="cname">Make</label>
            <input type="text" id="cname" name="car_details.make" required><br><br>
            <label for="mname">Model</label>
            <input type="text" id="mname" name="car_details.model" required><br><br>
            <label for="year">Year</label>
            <input type="number" id="year" name="car_details.year" required><br><br>
            <label for="pnum" required>Plate Number</label>
            <input type="text" id="pnum" name="car_details.platno">
          </fieldset>
          <button type="submit">Submit</button>
        </form>
      </div><br>
      <p>Choose your time slot</p>
      <input type="date" id="appointmentDatePicker"><br><br>
      <button id="showSlotsBtn">Show Available Slots</button>
      <div id="slotsContainer"></div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script>
      document.getElementById('g2Form').addEventListener('submit', function(event) {
          event.preventDefault();
          const formElement = document.getElementById('g2Form');
      
          const formData = new FormData(formElement);
          const data = {};
      
          formData.forEach((value, key) => {
              if(key.includes('.')) {
                  let parts = key.split('.');
                  let lastPart = parts.pop();
                  let obj = parts.reduce((acc, curr) => acc[curr] = acc[curr] || {}, data);
                  obj[lastPart] = value;
              } else {
                  data[key] = value;
              }
          });
      
          fetch('/update-details', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
              },
              body: JSON.stringify(data),
          })
          .then(response => {
              if (response.ok) {
                  return response.json();
              }
              throw new Error('Network response was not ok.');
          })
          .then(data => {
              console.log('Success:', data);
          })
          .catch((error) => {
              console.error('Error:', error);
          });
      });
      </script>

  <script>
    document.getElementById('showSlotsBtn').addEventListener('click', function() {
        const selectedDate = document.getElementById('appointmentDatePicker').value;
        if (!selectedDate) {
            alert('Please select a date.');
            return;
        }
        fetch(`/appointments?date=${selectedDate}`)
            .then(response => response.json())
            .then(slots => {
                const container = document.getElementById('slotsContainer');
                container.innerHTML = '';
                slots.forEach(slot => {
                    const button = document.createElement('button');
                    button.textContent = `Book ${slot.time}`;
                    button.addEventListener('click', () => bookAppointment(slot._id));
                    container.appendChild(button);
                });
            })
            .catch(error => console.error('Error:', error));
    });
    
    function bookAppointment(appointmentId) {
        fetch('/book-appointment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ appointmentId }),
        })
        .then(response => response.json())
        .then(data => {
            alert('Appointment booked successfully.');
            document.getElementById('showSlotsBtn').click();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to book the appointment.');
        });
    }
    </script>       
  </body>
</html>
